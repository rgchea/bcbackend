{# DROPZONE FILE UPLOADER#}
<script src="{{ asset('bundles/pizotearkadmin/js/dropzone/dropzone.js') }}"></script>
<link rel="stylesheet" href="{{ asset('bundles/pizotearkadmin/js/dropzone/dropzone.css') }}">

{# SCHEDULE #}
<script src="{{ asset('bundles/pizotearkadmin/js/dws_jquery_schedule/dist/jquery.schedule.min.js') }}"></script>
<link rel="stylesheet" href="{{ asset('bundles/pizotearkadmin/js/dws_jquery_schedule/dist/jquery.schedule.min.css') }}">

{# WYSIWYG #}
<script src="{{ asset('bundles/pizotearkadmin/js/ckeditor/ckeditor.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/pizotearkadmin/js/ckeditor/adapters/jquery.js')  }}"></script>


<style>
	.input-group {
		z-index: 0;
	}

	.dz-error-message{
		margin-top: 20px !important;
	}



</style>

<div class="container">

	<div class="row">	

		<div data-widget-editbutton="false" data-widget-colorbutton="false" id="wid-id-2" class="jarviswidget jarviswidget-sortable" style="" role="widget">

			<header class="header">
                            <h3 class="header-title">{{ 'label_form'|trans }}</h3>
                            <hr class="punteada"/>
			</header>

			<!-- widget div-->
			<div role="content">

				<!-- widget edit box -->
				<div class="jarviswidget-editbox">
					<!-- This area used as dropdown edit box -->

				</div>
				<!-- end widget edit box -->

				<!-- widget content -->
				<div class="widget-body">					
					{#<form id="backend_adminbundle_complex" action="{{path('backend_admin_common_area_create')}}" method="POST" name="backend_adminbundle_complex">#}
					{{ form_start(form) }}
					{{ form_errors(form) }}

					<fieldset>
						{% if edit is defined %}
							{% set myToken = entity.token %}
						{% else %}
							{% set myToken = token %}
						{% endif %}

						<input type="hidden" name="common_area[token]" value="{{ myToken }}">

						<div class="form-group col-md-6 col-md-offset-3">
							{{ form_label(form.name) }}
							{{ form_errors(form.name) }}
							{{ form_widget(form.name, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>

						<div class="form-group col-md-6 col-md-offset-3">
							{{ form_label(form.complex) }}
							{{ form_errors(form.complex) }}
							{{ form_widget(form.complex, { 'attr': {'class' : 'form-control classic' } }
							) }}
						</div>
						
						<div class="form-group col-md-6 col-md-offset-3">
							{{ form_label(form.description) }}
							{{ form_errors(form.description) }}
							{{ form_widget(form.description, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>
                                                
						<div class="form-group col-md-6 col-md-offset-3">
							{{ form_label(form.regulation) }}
							{{ form_errors(form.regulation) }}
							{{ form_widget(form.regulation, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>
						
						<div class="form-group col-md-6 col-md-offset-3">
							{{ form_label(form.termCondition) }}
							{{ form_errors(form.termCondition) }}
							{{ form_widget(form.termCondition) }}
						</div>						

						<div class="form-group col-md-6 col-md-offset-3">

                                                    <div class="checkbox">								
                                                        {{ form_label(form.requiredPayment) }}
                                                        {{ form_errors(form.requiredPayment) }}
                                                        {{ form_widget(form.requiredPayment, { 'attr': {'class' : 'checkbox' } }) }}

                                                    </div>
						</div>						
						<div class="form-group col-md-6 col-md-offset-3" id="div_common_area_price" style="display: none;">
							{{ form_label(form.price) }}
							{{ form_errors(form.price) }}
							{{ form_widget(form.price, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>
						
						<div class="form-group col-md-6 col-md-offset-3">
							<div class="checkbox">								
								{{ form_label(form.hasEquipment) }}
								{{ form_errors(form.hasEquipment) }}
								{{ form_widget(form.hasEquipment, { 'attr': {'class' : 'form-control' } }
								) }}								
							</div>

						</div>					

						<div class="form-group col-md-6 col-md-offset-3" id="div_equipment" style="display: none;">
							{{ form_label(form.equipmentDescription) }}
							{{ form_errors(form.equipmentDescription) }}
							{{ form_widget(form.equipmentDescription, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>						



						<div class="hide">
							{{ form_rest(form) }}
						</div>

					</fieldset>
                                        <br>                               
					<h2 class="no-margin">{{ 'label_common_area_schedule'|trans }}</h2>
                                        <hr style="border-width: 1px; border-style: dashed; border-color: #93a7b2;"/>
					<br>
					<div class="row">
                                            <div class="form-group col-xs-12">
                                                <div id="schedule" class="jqs-demo mb-3"></div>
                                                <input type="hidden" id="my_schedule" name="my_schedule">
                                            </div>
					</div>				
                                        <br>
                                        <h2 class="no-margin">{{ 'label_photo'|trans }} </h2>
                                        <hr style="border-width: 1px; border-style: dashed; border-color: #93a7b2;"/>
                                        <div class="row">
                                            <div class="form-group col-md-6 col-md-offset-3">
                                                
                                                <h5>5 {{ 'label_max_files'|trans }} </h5>
                                                <div class="dropzone my-dropzone" id="form_snippet_image"  action="{{path('common_area_ajax_snippet_image_send', {token: token})}}">
                                                </div>
                                            </div>
                                        </div>
                                        <br>                                        


                                        <div class="row">
                                            <div class="form-group col-md-6 col-md-offset-3">                                                
                                                <button type="submit" id="mySubmit" class="btn btn-primary btn-ps pull-right">{{ 'label_save'|trans }}</button>                                                                                                
                                                <a  href="{{ path('backend_admin_common_area_index') }}" class="btn btn-primary button-cancel btn-ps pull-right">{{ 'label_cancel'|trans }}</a>                                                
                                                <div class="clearfix"></div>
                                            </div>                                                
                                        </div>


					<!--</form>-->
					{{ form_end(form) }}
				<!-- end widget content -->
				</div>
		</div>
			<!-- end widget div -->

		</div>

	
</div>

</div>
<script type="text/javascript" language="Javascript">

	$( document ).ready(function() {


		$("#common_area_requiredPayment").change(function(){
			priceDisplayToggle(this.checked);
		});

		priceDisplayToggle($("#common_area_requiredPayment").is(":checked"));

		$("#common_area_hasEquipment").change(function(){
			equipmentDisplayToggle(this.checked);
		});

		equipmentDisplayToggle($("#common_area_hasEquipment").is(":checked"));


		//validate
		$("[name='common_area']").validate();
		//$("#common_area_reservationHourPeriod").rules("add", {required:true, digits:true, min: 1});


		//$("#common_area_zipCode").rules("add", {required:true, minlength: 4, digits:true});


		$('[name="common_area"]').on("submit", function(e){
			//Code: Action (like ajax...)
			if($("[name='common_area']").valid()){

				$('#pizote_spinner').show();
				$("#my_schedule").val($('#schedule').jqs("export"));

				return true;

			}
			else{
				return false;
			}

		});


		$('#schedule').jqs({

			periodColors: [
				['rgba(0, 0, 0, 0.5)', '#000', '#fff'],
				['rgba(200, 0, 0, 0.5)', '#f00', '#000'],
				['rgba(0, 200, 0, 0.5)', '#0f0', '#000'],
				['rgba(0, 0, 200, 0.5)', '#00f', '#000']
			],


			periodDuration: 60,
			periodOptions: false,
			periodTitle: '',
			//periodBackgroundColor: 'rgba(168, 205, 255, 0.6)',
			periodBorderColor: '#000',
			periodTextColor: '#fff',
			periodRemoveButton: 'Remove please !',
			periodTitlePlaceholder: 'A custom title',

			/*DAYS*/

			daysList: [
				'Monday',
				'Tuesday',
				'Wednesday',
				'Thursday',
				'Friday',
				'Saturday',
				'Sunday'
			],
			/*FUNCTIONS*/
			onInit: function () {},
			onAddPeriod: function (period, jqs) {
				//console.log(period);
				//console.log(jqs);

			},
			onRemovePeriod: function () {},
			onDuplicatePeriod: function () {},
			onClickPeriod: function () {}

		});


		{% if edit is defined %}

			{% set myPath =  url('backend_admin_homepage')~"/uploads/images/common_area/" %}
			{% set myPath = myPath|replace({'app_dev.php': ''}) %}
			{% set myPath = myPath|replace({'/en/': ''}) %}
			{% set myPath = myPath|replace({'/es/': ''}) %}


			{#SCHEDULE IMPORT #}
			$('#schedule').jqs('import', {{ availability|raw }});

		{% endif %}

			////DROPZONE
			var countFiles = 0;
			var uploadedFiles = 0;

			var _actionToDropZone = $("#form_snippet_image").attr('action');
			Dropzone.autoDiscover = false;
			//$(".dz-hidden-input").prop("disabled",false);

			var myDropzone = new Dropzone("#form_snippet_image", {
				url: _actionToDropZone,
				maxFilesize: 3, // MB
				maxFiles: 5,
				addRemoveLinks: true,
				createImageThumbnails: true,
				acceptedFiles: ".png,.jpg,.jpeg",
				thumbnailWidth: 250,
				thumbnailHeight: 250,
				autoProcessQueue: true,
				parallelUploads: 5,
				uploadMultiple: false,
				success: function(file, response){
					//console.log(response.success);
					file.id = response.success;
					//return true;
					//alert("finish");

				},


					init: function() {
						thisDropzone = this;

						// First change the button to actually tell Dropzone to process the queue.
						/*
						document.getElementById("mySubmit").addEventListener("click", function(e) {
							// Make sure that the form isn't actually being sent.
							e.preventDefault();
							e.stopPropagation();
							thisDropzone.processQueue();
						});
						*/




						{% if edit is defined %}

							$.get("{{path('common_area_ajax_snippet_image_get')}}",{common_area: '{{ entity.id }}' }, function(data) {

								$.each(data, function(key,value){

									//var mockFile = { name: value.name, size: value.size };
									var mockFile = { name: value.name, size: "", id: value.id };

									thisDropzone.options.addedfile.call(thisDropzone, mockFile);
									thisDropzone.options.thumbnail.call(thisDropzone, mockFile, '{{ myPath }}'+value.name);

									//console.log('{{ myPath }}'+value.name);
									thisDropzone.emit("complete", mockFile);

									//on click opens a new tab with the image
									var src = '{{ myPath }}'+value.name;
									mockFile.previewElement.addEventListener("click", function() {
										var win = window.open(src, '_blank');
										win.focus();
									});

									countFiles++;
									if(countFiles >= 5){
										myDropzone.disable();
									}

								});

								//$(".dz-hidden-input").prop("disabled",true);

							});
						{% endif %}
						{#
						this.on("maxfilesexceeded", function(file){
							alert("{{ 'label_no_more_files'|trans }}");
							//this.removeFile(file);
							//countFiles--;
							myDropzone.disable();


						});

						#}

						this.on('removedfile', function (file) {

							//console.log(file);
							//$('#pizote_spinner').show();
							countFiles--;
							uploadedFiles--;
							{% if edit is defined %}
								$.ajax({
									type: 'POST',
									url: "{{path('common_area_ajax_snippet_image_remove')}}",
									//data: {id: file.name, _token: $('#csrf-token').val()},
									data: {id: file.id, name: file.name},
									dataType: 'html',
									success: function (data) {
										var rep = JSON.parse(data);

										if(countFiles < 5){
											myDropzone.enable();
										}
										//$('#pizote_spinner').hide();
									}

								})
							{% else %}

								if(countFiles < 5){
									myDropzone.enable();
								}
							{% endif %}

						});

						this.on("addedfile", function(file) {
							countFiles++;

							if(countFiles > 5){

								alert("{{ 'label_no_more_files'|trans }}");
								myDropzone.disable();

								$("[name='common_area']").submit(function(e){
									//e.preventDefault();
									$('#pizote_spinner').hide();
								});
							}
						});

						/*
						this.on("totaluploadprogress", function(totalPercentage, totalBytesSent){


							if(totalPercentage >= 100 && totalBytesSent) {

								$('#pizote_spinner').show();
								$("[name='common_area']").submit();

							}
						});
						*/

					}

			});



			/*
			myDropzone.on("addedfile", function(file) {
				alert('nouveau fichier re√ßu');
			});
			*/
			{% if edit is defined %}
				$("#common_area_complex").val({{ entity.complex.id }});
			{% endif %}



	});

	function priceDisplayToggle(isChecked){


		if(isChecked){
			$("#div_common_area_price").show();
		}
		else{
			$("#div_common_area_price").hide();
		}

	}

	function equipmentDisplayToggle(isChecked){


		if(isChecked){
			$("#div_equipment").show();
		}
		else{
			$("#div_equipment").hide();
		}

	}




</script>