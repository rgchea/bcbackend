<script src="{{ asset('bundles/pizotearkadmin/js/dropzone/dropzone.js') }}"></script>
<link rel="stylesheet" href="{{ asset('bundles/pizotearkadmin/js/dropzone/dropzone.css') }}">

<style>
	.input-group {
		z-index: 0;
	}
</style>
<div class="row">
	<div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">

	</div>

	{% if isAdShared != 0 %}
		<div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
			<h4>
				<label class="pull-right" >{{ 'label_property_share_ad_msg'|trans }}{{ isAdSharedDays }}&nbsp;{{ 'label_days'|trans }}</label>
			</h4>
			<br/>
			<div class="col-xs-12 col-sm-5 col-md-5 col-lg-8" style="float: right">
				<a class="pull-right btn btn-primary btn-lg" href="{{ path('backend_admin_property_delete_ad', {propertyID: entity.id, ticketID: isAdShared}) }}">
					{{ 'label_property_delete_ad'|trans }}
				</a>
			</div>


		</div>
	{% else %}
		{% if app.user.role.name == "ADMIN" %}{#EVALUAR QUE ROLES TENDRAN ACCESO A CREAR PROPIEDADES#}
			<div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
				<a class="pull-right btn btn-primary btn-lg" href="{{ path('backend_admin_property_share_ad', {propertyID: entity.id}) }}">
					{{ 'label_property_share_ad'|trans }}
				</a>
			</div>
		{% endif %}

	{% endif %}

</div>

<div class="row">
	<article class="col-sm-12 col-md-12 col-lg-12 sortable-grid ui-sortable">

		<div data-widget-editbutton="false" data-widget-colorbutton="false" id="wid-id-2" class="jarviswidget jarviswidget-sortable" style="" role="widget">

			<header role="heading">
				<h2>{{ 'label_form'|trans }}</h2>

			</header>

			<!-- widget div-->
			<div role="content">

				<!-- widget edit box -->
				<div class="jarviswidget-editbox">
					<!-- This area used as dropdown edit box -->

				</div>
				<!-- end widget edit box -->

				<!-- widget content -->
				<div class="widget-body">

					<div class="form-inputs-g">
					{{ form_start(form) }}
					{{ form_errors(form) }}

					<fieldset>


						<div class="form-group col-md-4">
							{{ form_label(form.name) }}
							{{ form_errors(form.name) }}
							{{ form_widget(form.name, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>
						<div class="form-group col-md-4">
							{{ form_label(form.code) }}
							{{ form_errors(form.code) }}
							{{ form_widget(form.code, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>
						<div class="clearfix"></div>
						<div class="form-group col-md-4">
							{{ form_label(form.complex) }}
							{{ form_errors(form.complex) }}
							{{ form_widget(form.complex, { 'attr': {'class' : 'form-control classic' } }
							) }}
						</div>

						<div class="form-group col-md-4" id="div_property_complexSector">

							{{ form_label(form.complexSector) }}
							{{ form_errors(form.complexSector) }}
							{{ form_widget(form.complexSector, { 'attr': {'class' : 'form-control classic' } }
							) }}
						</div>

						<div class="clearfix"></div>
						<div class="form-group col-md-8">
							{{ form_label(form.propertyType) }}
							{{ form_errors(form.propertyType) }}
							{{ form_widget(form.propertyType, { 'attr': {'class' : 'form-control classic' } }
							) }}
						</div>
						<div class="col-md-2">
							<label>&nbsp;</label>
							<input type="text" class="form-control" id="inputPropertyType" name="extra[propertyTypeName]" style="display: none" placeholder="{{ 'label_name'|trans }}">
						</div>
						<div class="clearfix"></div>

						<div class="form-group col-md-8">
							{{ form_label(form.address) }}
							{{ form_errors(form.address) }}
							{{ form_widget(form.address, { 'attr': {'class' : 'form-control' } }
							) }}
						</div>



						<div class="clearfix"></div>


						<div class="hide">
							{{ form_rest(form) }}
						</div>

					</fieldset>

						<div class="clearfix"></div>
						<br/>

						{% if edit is defined %}
							<h3>{{ 'label_photo'|trans }} </h3>
							<h2>{{ 'label_max_files'|trans }} </h2>
							<div class="dropzone my-dropzone" id="form_snippet_image" action="{{path('property_ajax_snippet_image_send')}}">
							</div>
							<br/>
						{% endif %}


					<div class="form-actions">

						<button class="btn btn-primary">
							<i class="fa fa-save"></i>
							{{ 'label_save'|trans  }}
						</button>
					</div>

					<!--</form>-->
					{{ form_end(form) }}
					</div>
				</div>
				<!-- end widget content -->

			</div>
			<!-- end widget div -->

		</div>

		<div class="clearfix"></div>

	</article>
</div>

<script type="text/javascript" language="Javascript">

	$( document ).ready(function() {


		//alert($("#complexSectorType").val());


		$("#complexSectorType").change(function(){
			myValue =$("#complexSectorType option:selected").attr('value');

			if(myValue == 0){
				$("#inputSectionName").show();
				$("#inputSectionName").rules("add", {required:true});

			}
			else{
				$("#inputSectionName").hide();
				$("#inputSectionName-error").hide();
				$("#inputSectionName").rules("add", {required:false});
			}


		});



		//propertyType
		$("#property_propertyType").change(function(){
			myValue =$("#property_propertyType option:selected").attr('value');

			if(myValue == 0){
				$("#inputPropertyType").show();
				$("#inputPropertyType").rules("add", {required:true});
			}
			else{
				$("#inputPropertyType").hide();
				$("#inputPropertyType-error").hide();
				$("#inputPropertyType").rules("add", {required:false});
			}

		});





		$("[name='property']").validate({
			success: function(error){

				return true;
			},

		});
		//$("#property_zipCode").rules("add", {required:true, minlength: 4, digits:true});


		$('[name="property"]').on("submit", function(){
			//Code: Action (like ajax...)
			if($("[name='complex']").valid()){
				$('#pizote_spinner').show();
				return true;

			}
			else{
				return false;
			}

		});



		{% if edit is defined %}

			{% set myPath =  url('backend_admin_homepage')~"/uploads/images/property/" %}
			{% set myPath = myPath|replace({'app_dev.php': ''}) %}
			{% set myPath = myPath|replace({'/en/': ''}) %}
			{% set myPath = myPath|replace({'/es/': ''}) %}


			////DROPZONE
			var countFiles = 0;
			var _actionToDropZone = $("#form_snippet_image").attr('action');
			Dropzone.autoDiscover = false;
			//$(".dz-hidden-input").prop("disabled",false);

			var myDropzone = new Dropzone("#form_snippet_image", {
				url: _actionToDropZone,
				params: {
					property: {{ entity.id }}
				},
				maxFilesize: 1, // MB
				maxFiles: 5,
				addRemoveLinks: true,
				createImageThumbnails: true,
				acceptedFiles: ".png,.jpg,.jpeg",
				thumbnailWidth: 250,
				thumbnailHeight: 250,
				autoProcessQueue: true,
				parallelUploads: 1,
				uploadMultiple: false,
				success: function(file, response){
					//console.log(response.success);
					file.id = response.success;

				},
				error: function(file, response){
					//console.log(response.success);
					file.id = response.success;
					if(countFiles > 5){
						myDropzone.disable();
					}


				},

				init: function() {
					thisDropzone = this;

					$.get("{{path('property_ajax_snippet_image_get')}}",{property: '{{ entity.id }}' }, function(data) {


						$.each(data, function(key,value){

							//var mockFile = { name: value.name, size: value.size };
							var mockFile = { name: value.name, size: "", id: value.id };

							thisDropzone.options.addedfile.call(thisDropzone, mockFile);
							thisDropzone.options.thumbnail.call(thisDropzone, mockFile, '{{ myPath }}'+value.name);

							//console.log('{{ myPath }}'+value.name);
							thisDropzone.emit("complete", mockFile);
							countFiles++;
							if(countFiles >= 5){
								myDropzone.disable();
							}

						});

						//$(".dz-hidden-input").prop("disabled",true);


					});

					this.on("maxfilesexceeded", function(file){
						alert("{{ 'label_no_more_files'|trans }}");
						this.removeFile(file);
						countFiles--;
						//myDropzone.disable();
					});

					this.on('removedfile', function (file) {

						//console.log(file);

						$.ajax({
							type: 'POST',
							url: "{{path('property_ajax_snippet_image_remove')}}",
							//data: {id: file.name, _token: $('#csrf-token').val()},
							data: {id: file.id, name: file.name},
							dataType: 'html',
							success: function (data) {
								var rep = JSON.parse(data);
								countFiles--;
								if(countFiles < 5){
									myDropzone.enable();
								}

							}
						})


					});

					this.on("addedfile", function(file) {
						countFiles++;
						if(countFiles > 5){
							this.removeFile(file);
							countFiles--;
							myDropzone.disable();
						}
					});


				}

			});


			/*
			myDropzone.on("addedfile", function(file) {
				alert('nouveau fichier re√ßu');
			});
			*/


			$("#property_complex").val({{ entity.complex.id }});


		{% endif %}

		changeSection();

		$("#property_complex").change(function(){
			changeSection();
		});


	});

	function changeSection(){

		myComplex = $("#property_complex").val();

		{% if edit is defined %}
			selectedSection = '{{ entity.complexSector.id }}';
		{% else %}
			selectedSection = 0;
		{% endif %}

		$.ajax({
			type:"POST",
			dataType:"html",
			async:false,
			url:"{{ path('backend_admin_property_change_section') }}",
			//data:"countryShort="+myCountry,
			data: {complexID: myComplex, selectedSection: selectedSection},
			success:function(data){
				$("#property_complexSector").html(data);
			}
		});

	}





</script>